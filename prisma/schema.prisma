generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminRole {
  id          Int           @id @default(autoincrement())
  userId      String        @unique
  roleType    AdminRoleType
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  lastLogin   DateTime?
  permissions Json?
  users       users         @relation(fields: [userId], references: [id])
}

model Country {
  id           Int            @id @default(autoincrement())
  name         String
  currency     String
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Organization Organization[]
}

model Customer {
  id                       String                     @id @default(uuid())
  name                     String
  phone                    String?
  email                    String?
  address                  String?
  latitude                 Float?
  longitude                Float?
  accountStatus            CustomerStatus             @default(ACTIVE)
  joinedDate               DateTime                   @default(now())
  organizationId           Int
  userId                   String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  vehicleCondition         VehicleConditionEnum?
  vehicleMake              String?
  vehicleModel             String?
  vehicleType              VehicleTypeEnum?
  vehicleYear              Int?
  vehicleNumber            String?
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  users                    users?                     @relation(fields: [userId], references: [id])
  Lead                     Lead[]
  Order                    Order[]
  Invoice                  Invoice[]
  Payment                  Payment[]
  Review                   Review[]
  pickup_requests          pickup_requests[]
  scrap_collection_records scrap_collection_records[]
}

model Employee {
  id                       String                     @id @default(uuid())
  organizationId           Int
  userId                   String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  scrapYardId              String?
  completedPickups         Int                        @default(0)
  deviceToken              String?
  email                    String
  fullName                 String
  isActive                 Boolean                    @default(true)
  passwordHash             String
  phone                    String
  profilePhoto             String?
  rating                   Float?                     @default(0)
  cityId                   Int?
  roleId                   Int
  crewId                   String?
  cities                   cities?                    @relation(fields: [cityId], references: [id])
  crews                    crews?                     @relation(fields: [crewId], references: [id])
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  roles                    roles                      @relation(fields: [roleId], references: [id])
  scrap_yards              scrap_yards?               @relation(fields: [scrapYardId], references: [id])
  users                    users?                     @relation(fields: [userId], references: [id])
  Order                    Order[]
  Payment                  Payment[]
  Review                   Review[]
  assign_orders            assign_orders[]
  collector_assignments    collector_assignments[]
  pickup_requests          pickup_requests[]
  scrap_collection_records scrap_collection_records[]
}

model Lead {
  id               String               @id @default(uuid())
  organizationId   Int
  email            String?
  status           LeadStatus
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  customerId       String?
  fullName         String
  latitude         Float?
  leadSource       LeadSourceEnum
  locationAddress  String?
  longitude        Float?
  notes            String?
  phone            String?
  photos           Json?
  vehicleCondition VehicleConditionEnum
  vehicleMake      String?
  vehicleModel     String?
  vehicleType      VehicleTypeEnum
  vehicleYear      Int?
  Customer         Customer?            @relation(fields: [customerId], references: [id])
  Organization     Organization         @relation(fields: [organizationId], references: [id])
  Order            Order?
  chatbot_leads    chatbot_leads?
  lead_timelines   lead_timelines[]

  @@index([organizationId, createdAt])
  @@index([organizationId, status, vehicleCondition])
  @@index([organizationId, vehicleCondition])
}

model Order {
  id                       String                     @id @default(uuid())
  organizationId           Int
  customerId               String?
  leadId                   String?                    @unique
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  actualPrice              Float?
  address                  String
  adminNotes               String?
  assignedCollectorId      String?
  customerName             String
  customerNotes            String?

  latitude                 Float?
  longitude                Float?
  orderStatus              OrderStatus
  paymentStatus            PaymentStatusEnum
  pickupTime               DateTime?
  quotedPrice              Float?
  vehicleDetails           Json
  yardId                   String?
  orderNumber              String?                    @unique
  crewId                   String?
  routeDistance            String?
  routeDuration            String?
  instructions             String?
  customerEmail            String?
  photos                   Json?
  Employee                 Employee?                  @relation(fields: [assignedCollectorId], references: [id])
  crews                    crews?                     @relation(fields: [crewId], references: [id])
  Customer                 Customer?                  @relation(fields: [customerId], references: [id])
  Lead                     Lead?                      @relation(fields: [leadId], references: [id])
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  scrap_yards              scrap_yards?               @relation(fields: [yardId], references: [id])
  Payment                  Payment?
  Review                   Review?
  Invoice                  Invoice[]
  assign_orders            assign_orders[]
  order_timelines          order_timelines[]
  pickup_requests          pickup_requests?
  scrap_collection_records scrap_collection_records[]

  @@index([assignedCollectorId])
  @@index([crewId])
  @@index([organizationId, createdAt])
  @@index([organizationId, orderStatus])
  @@index([yardId])
}

model Invoice {
  id             String        @id @default(uuid())
  invoiceNumber  String        @unique
  customerId     String
  workOrderId    String?
  organizationId Int
  invoiceDate    DateTime
  dueDate        DateTime
  status         InvoiceStatus @default(DRAFT)
  subtotal       Float
  tax            Float         @default(0)
  discount       Float         @default(0)
  total          Float
  notes          String?
  terms          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  Customer       Customer      @relation(fields: [customerId], references: [id])
  WorkOrder      Order?        @relation(fields: [workOrderId], references: [id])
  Organization   Organization  @relation(fields: [organizationId], references: [id])
  items          InvoiceItem[]
  
  @@index([customerId])
  @@index([workOrderId])
  @@index([organizationId, createdAt])
  @@index([organizationId, status])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Float
  unitPrice   Float
  amount      Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  Invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
}

model Organization {
  id                       Int                        @id @default(autoincrement())
  name                     String
  address                  String?
  phone                    String?
  email                    String?
  website                  String?
  logo                     String?
  description              String?
  isActive                 Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  countryId                Int?
  billingAddress           String?
  latitude                 Float?
  longitude                Float?
  Customer                 Customer[]
  Employee                 Employee[]
  Lead                     Lead[]
  Order                    Order[]
  Invoice                  Invoice[]
  Country                  Country?                   @relation(fields: [countryId], references: [id], onDelete: Restrict)
  Payment                  Payment[]
  Review                   Review[]
  collector_assignments    collector_assignments[]
  email_templates          email_templates[]
  pickup_requests          pickup_requests[]
  scrap_categories         scrap_categories[]
  scrap_names              scrap_names[]
  scrap_yards              scrap_yards[]
  users                    users[]
  vehicle_names            vehicle_names[]
  vehicle_types            vehicle_types[]
  crews                    crews[]
}

model Payment {
  id             String            @id @default(uuid())
  organizationId Int
  customerId     String
  orderId        String            @unique
  amount         Float
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  collectorId    String?
  paymentType    PaymentTypeEnum
  receiptUrl     String?
  status         PaymentStatusEnum
  Employee       Employee?         @relation(fields: [collectorId], references: [id])
  Customer       Customer          @relation(fields: [customerId], references: [id])
  Order          Order             @relation(fields: [orderId], references: [id])
  Organization   Organization      @relation(fields: [organizationId], references: [id])
  refunds        refunds?
}

model Review {
  id             String       @id @default(uuid())
  organizationId Int
  customerId     String
  orderId        String       @unique
  rating         Int
  comment        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  collectorId    String
  Employee       Employee     @relation(fields: [collectorId], references: [id])
  Customer       Customer     @relation(fields: [customerId], references: [id])
  Order          Order        @relation(fields: [orderId], references: [id])
  Organization   Organization @relation(fields: [organizationId], references: [id])
}

model ai_auto_quotes {
  id             String            @id @default(uuid())
  customerId     String?
  vehicleDetails Json
  generatedPrice Float
  respondedVia   QuoteResponseEnum
  timestamp      DateTime          @default(now())
  createdAt      DateTime          @default(now())
}

model ai_price_estimators {
  id                String               @id @default(uuid())
  make              String
  model             String
  year              Int
  condition         VehicleConditionEnum
  location          String?
  metalMarketRate   Float?
  estimatedPriceMin Float
  estimatedPriceMax Float
  confidenceScore   Float
  createdAt         DateTime             @default(now())
}

model assign_orders {
  id               String           @id @default(uuid())
  orderId          String
  collectorId      String?
  crewId           String?
  assignedAt       DateTime         @default(now())
  startTime        DateTime?
  endTime          DateTime?
  notes            String?
  status           AssignmentStatus @default(PENDING)
  completedAt      DateTime?
  completionNotes  String?
  completionPhotos Json?
  Employee                 Employee?                  @relation(fields: [collectorId], references: [id])
  crews                    crews?                     @relation(fields: [crewId], references: [id])
  Order                    Order                      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  scrap_collection_records scrap_collection_records[]
}

model chatbot_leads {
  id             String   @id @default(uuid())
  name           String
  phone          String
  vehicleDetails Json
  location       String?
  chatLog        Json?
  leadId         String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  Lead           Lead?    @relation(fields: [leadId], references: [id])
}

model cities {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @unique
  latitude              Float
  longitude             Float
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime @updatedAt
  scrapYardId           String?
  Employee              Employee[]
  scrap_yards           scrap_yards?            @relation(fields: [scrapYardId], references: [id])
  collector_assignments collector_assignments[]
}

model collector_assignments {
  id             String         @id @default(uuid())
  collectorId    String?
  vehicleNameId  String?
  cityId         Int?
  organizationId Int
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  crewId         String?
  scrapYardId    String?
  cities         cities?        @relation(fields: [cityId], references: [id])
  Employee       Employee?      @relation(fields: [collectorId], references: [id])
  crews          crews?         @relation(fields: [crewId], references: [id])
  Organization   Organization   @relation(fields: [organizationId], references: [id])
  scrap_yards    scrap_yards?   @relation(fields: [scrapYardId], references: [id])
  vehicle_names  vehicle_names? @relation(fields: [vehicleNameId], references: [id])
}

model crews {
  id                    String                  @id @default(uuid())
  name                  String
  description           String?
  isActive              Boolean                 @default(true)
  organizationId        Int
  Organization          Organization            @relation(fields: [organizationId], references: [id])
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  Employee              Employee[]
  Order                 Order[]
  assign_orders         assign_orders[]
  collector_assignments collector_assignments[]

  @@unique([name, organizationId])
}

model email_templates {
  id             String       @id @default(uuid())
  name           String
  subject        String
  body           String
  variables      Json?
  organizationId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  Organization   Organization @relation(fields: [organizationId], references: [id])
}

model lead_timelines {
  id          String   @id @default(uuid())
  leadId      String
  activity    String
  performedBy String?
  createdAt   DateTime @default(now())
  Lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model notifications {
  id        Int              @id @default(autoincrement())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  users     users            @relation(fields: [userId], references: [id])
}

model order_timelines {
  id          String      @id @default(uuid())
  orderId     String
  status      OrderStatus
  notes       String?
  performedBy String?
  createdAt   DateTime    @default(now())
  Order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model pickup_requests {
  id             String              @id @default(uuid())
  customerId     String
  vehicleDetails Json
  pickupAddress  String
  latitude       Float?
  longitude      Float?
  status         PickupRequestStatus
  assignedTo     String?
  orderId        String?             @unique
  organizationId Int
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  Employee       Employee?           @relation(fields: [assignedTo], references: [id])
  Customer       Customer            @relation(fields: [customerId], references: [id])
  Order          Order?              @relation(fields: [orderId], references: [id])
  Organization   Organization        @relation(fields: [organizationId], references: [id])
}

model refunds {
  id               String   @id @default(uuid())
  paymentId        String   @unique
  amount           Float
  reason           String?
  processedByAdmin String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Payment          Payment  @relation(fields: [paymentId], references: [id])
}

model roles {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  Employee    Employee[]
}

model scrap_categories {
  id                       String                     @id @default(uuid())
  name                     String
  description              String?
  organizationId           Int
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  isActive                 Boolean                    @default(true)
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  scrap_collection_records scrap_collection_records[]
  scrap_names              scrap_names[]
}

model scrap_collection_records {
  id                 String                 @id @default(uuid())
  // Foreign Keys
  workOrderId        String?                // Work Order ID
  assignOrderId      String?                // Assign Order ID
  customerId         String?                // Customer ID
  scrapCategoryId    String                 // Scrap Category ID
  scrapNameId        String?                // Scrap Name ID
  collectorId        String                 // Collector ID (Employee)
  
  // Collection Details
  collectionDate     DateTime               @default(now())
  scrapDescription   String
  scrapCondition     ScrapConditionEnum
  make               String?
  model              String?
  yearOfManufacture  String?
  weight             Float?
  quantity           Int?                   // Optional
  
  // Amounts
  quotedAmount       Float
  finalAmount        Float
  
  // Photos & Signatures (Digital Ocean paths)
  photos             Json?                  // Array of photo URLs
  customerSignature  String?                // Customer signature URL
  collectorSignature String?                // Collector signature URL
  
  // Status
  collectionStatus   CollectionRecordStatus @default(SUBMITTED)
  
  // Timestamps
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  
  // Relations
  Employee           Employee               @relation(fields: [collectorId], references: [id])
  Customer           Customer?              @relation(fields: [customerId], references: [id])
  Order              Order?                 @relation(fields: [workOrderId], references: [id])
  assign_orders      assign_orders?         @relation(fields: [assignOrderId], references: [id])
  scrap_categories   scrap_categories       @relation(fields: [scrapCategoryId], references: [id])
  scrap_names        scrap_names?           @relation(fields: [scrapNameId], references: [id])

  @@index([collectionDate])
  @@index([collectorId])
  @@index([customerId])
  @@index([workOrderId])
  @@index([collectionStatus])
}

model scrap_names {
  id                       String                     @id @default(uuid())
  name                     String
  isActive                 Boolean                    @default(true)
  scrapCategoryId          String
  organizationId           Int
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  scrap_collection_records scrap_collection_records[]
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  scrap_categories         scrap_categories           @relation(fields: [scrapCategoryId], references: [id])

  @@unique([name, scrapCategoryId, organizationId])
}

model scrap_yards {
  id                       String                     @id @default(uuid())
  yardName                 String
  address                  String
  latitude                 Float?
  longitude                Float?
  assignedEmployeeIds      Json?
  operatingHours           Json?
  organizationId           Int
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  isActive                 Boolean                    @default(true)
  managerId                String?
  Employee                 Employee[]
  Order                    Order[]
  cities                   cities[]
  collector_assignments    collector_assignments[]
  Organization             Organization               @relation(fields: [organizationId], references: [id])
  vehicle_names            vehicle_names[]
}

model users {
  id             String          @id @default(uuid())
  email          String          @unique
  phone          String?
  password       String?
  hashPassword   String?
  firstName      String?
  lastName       String?
  profileImg     String?
  role           UserRole        @default(USER)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId Int?
  AdminRole      AdminRole?
  Customer       Customer[]
  Employee       Employee[]
  notifications  notifications[]
  Organization   Organization?   @relation(fields: [organizationId], references: [id])
}

model vehicle_names {
  id                    String                  @id @default(uuid())
  name                  String
  vehicleTypeId         Int
  scrapYardId           String?
  organizationId        Int
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  make                  String?
  model                 String?
  vehicleNumber         String?
  year                  Int?
  collector_assignments collector_assignments[]
  Organization          Organization            @relation(fields: [organizationId], references: [id])
  scrap_yards           scrap_yards?            @relation(fields: [scrapYardId], references: [id])
  vehicle_types         vehicle_types           @relation(fields: [vehicleTypeId], references: [id])

  @@unique([name, vehicleTypeId, organizationId])
}

model vehicle_types {
  id             Int             @id @default(autoincrement())
  name           String
  icon           String?
  organizationId Int?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  vehicle_names  vehicle_names[]
  Organization   Organization?   @relation(fields: [organizationId], references: [id])

  @@unique([name, organizationId])
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum AdminRoleType {
  SUPER_ADMIN
  STAFF_ADMIN
}

enum CollectionRecordStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
}

enum CustomerStatus {
  ACTIVE
  BLOCKED
  INACTIVE
  VIP
}

enum EmployeeRole {
  COLLECTOR
  ADMIN
  SUPERVISOR
  ACCOUNTANT
}

enum LeadSourceEnum {
  WEBFORM
  CHATBOT
  CALL
  MANUAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUOTED
  CONVERTED
  REJECTED
}

enum NotificationType {
  PICKUP_REQUEST
  PAYMENT_CONFIRMATION
  STATUS_UPDATE
  NEW_ASSIGNMENT
  ORDER_COMPLETED
  REFUND_PROCESSED
}

enum OrderStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentMethodEnum {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
  ONLINE
}

enum PaymentStatusEnum {
  UNPAID
  PAID
  REFUNDED
}

enum PaymentTypeEnum {
  CASH
  CARD
  ONLINE
  BANK_TRANSFER
}

enum PickupRequestStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum QuoteResponseEnum {
  EMAIL
  SMS
  CHATBOT
}

enum ScrapConditionEnum {
  JUNK
  DAMAGED
  WRECKED
  ACCIDENTAL
  FULLY_SCRAP
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
  CUSTOMER
}

enum VehicleConditionEnum {
  JUNK
  DAMAGED
  WRECKED
  ACCIDENTAL
  FULLY_SCRAP
}

enum VehicleTypeEnum {
  CAR
  BIKE
  TRUCK
  BOAT
  VAN
  SUV
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}
