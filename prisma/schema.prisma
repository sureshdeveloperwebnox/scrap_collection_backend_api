generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  phone          String?
  password       String?
  hashPassword   String?
  firstName      String?
  lastName       String?
  role           UserRole       @default(USER)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId Int?
  adminRoles     AdminRole?
  customers      Customer[]
  employees      Employee[]
  notifications  Notification[]
  organization   Organization?  @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model AdminRole {
  id          Int           @id @default(autoincrement())
  userId      String        @unique
  roleType    AdminRoleType
  permissions Json?
  lastLogin   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
}

model Organization {
  id                   Int                   @id @default(autoincrement())
  name                 String
  address              String?
  phone                String?
  email                String?
  website              String?
  logo                 String?
  description          String?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  countryId            Int
  customers            Customer[]
  employees            Employee[]
  leads                Lead[]
  orders               Order[]
  country              Country               @relation(fields: [countryId], references: [id])
  payments             Payment[]
  reviews              Review[]
  collectorAssignments CollectorAssignment[]
  emailTemplates       EmailTemplate[]
  pickupRequests       PickupRequest[]
  scrapCategories      ScrapCategory[]
  scrapYards           ScrapYard[]
  users                User[]
  vehicleNames         VehicleName[]
  vehicleTypes         VehicleType[]
}

model Customer {
  id               String                @id @default(uuid())
  name             String
  phone            String
  email            String?
  address          String?
  latitude         Float?
  longitude        Float?
  accountStatus    CustomerStatus        @default(ACTIVE)
  joinedDate       DateTime              @default(now())
  organizationId   Int
  userId           String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  vehicleCondition VehicleConditionEnum?
  vehicleMake      String?
  vehicleModel     String?
  vehicleNumber    String?
  vehicleType      VehicleTypeEnum?
  vehicleYear      Int?
  organization     Organization          @relation(fields: [organizationId], references: [id])
  user             User?                 @relation(fields: [userId], references: [id])
  leads            Lead[]
  orders           Order[]
  payments         Payment[]
  reviews          Review[]
  pickupRequests   PickupRequest[]
}

model Role {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]

  @@map("roles")
}

model Employee {
  id                   String                @id @default(uuid())
  fullName             String
  email                String
  phone                String
  passwordHash         String
  isActive             Boolean               @default(true)
  profilePhoto         String?
  rating               Float?                @default(0)
  completedPickups     Int                   @default(0)
  deviceToken          String?
  organizationId       Int
  userId               String?
  scrapYardId          String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  cityId               Int?
  roleId               Int
  city                 City?                 @relation(fields: [cityId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id])
  role                 Role                  @relation(fields: [roleId], references: [id])
  scrapYard            ScrapYard?            @relation(fields: [scrapYardId], references: [id])
  user                 User?                 @relation(fields: [userId], references: [id])
  orders               Order[]
  payments             Payment[]
  reviews              Review[]
  collectorAssignments CollectorAssignment[]
  pickupRequests       PickupRequest[]
}

model Lead {
  id               String               @id @default(uuid())
  fullName         String
  phone            String
  email            String?
  vehicleType      VehicleTypeEnum
  vehicleMake      String?
  vehicleModel     String?
  vehicleYear      Int?
  vehicleCondition VehicleConditionEnum
  locationAddress  String?
  latitude         Float?
  longitude        Float?
  leadSource       LeadSourceEnum
  photos           Json?
  notes            String?
  status           LeadStatus
  organizationId   Int
  customerId       String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  customer         Customer?            @relation(fields: [customerId], references: [id])
  organization     Organization         @relation(fields: [organizationId], references: [id])
  order            Order?
  chatbotLead      ChatbotLead?
  timeline         LeadTimeline[]

  @@index([organizationId, vehicleCondition])
  @@index([organizationId, status, vehicleCondition])
  @@index([organizationId, createdAt])
}

model LeadTimeline {
  id          String   @id @default(uuid())
  leadId      String
  activity    String
  performedBy String?
  createdAt   DateTime @default(now())
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("lead_timelines")
}

model Order {
  id                  String            @id @default(uuid())
  leadId              String?           @unique
  customerName        String
  customerPhone       String
  address             String
  latitude            Float?
  longitude           Float?
  vehicleDetails      Json
  assignedCollectorId String?
  pickupTime          DateTime?
  orderStatus         OrderStatus
  paymentStatus       PaymentStatusEnum
  quotedPrice         Float?
  actualPrice         Float?
  yardId              String?
  customerNotes       String?
  adminNotes          String?
  organizationId      Int
  customerId          String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  assignedCollector   Employee?         @relation(fields: [assignedCollectorId], references: [id])
  customer            Customer?         @relation(fields: [customerId], references: [id])
  lead                Lead?             @relation(fields: [leadId], references: [id])
  organization        Organization      @relation(fields: [organizationId], references: [id])
  yard                ScrapYard?        @relation(fields: [yardId], references: [id])
  payment             Payment?
  review              Review?
  orderTimeline       OrderTimeline[]
  pickupRequest       PickupRequest?
}

model OrderTimeline {
  id          String      @id @default(uuid())
  orderId     String
  status      OrderStatus
  notes       String?
  performedBy String?
  createdAt   DateTime    @default(now())
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_timelines")
}

model PickupRequest {
  id                String              @id @default(uuid())
  customerId        String
  vehicleDetails    Json
  pickupAddress     String
  latitude          Float?
  longitude         Float?
  status            PickupRequestStatus
  assignedTo        String?
  orderId           String?             @unique
  organizationId    Int
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  assignedCollector Employee?           @relation(fields: [assignedTo], references: [id])
  customer          Customer            @relation(fields: [customerId], references: [id])
  order             Order?              @relation(fields: [orderId], references: [id])
  organization      Organization        @relation(fields: [organizationId], references: [id])

  @@map("pickup_requests")
}

model ScrapYard {
  id                  String       @id @default(uuid())
  yardName            String
  address             String
  latitude            Float?
  longitude           Float?
  assignedEmployeeIds Json?
  operatingHours      Json?
  organizationId      Int
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  isActive            Boolean      @default(true)
  employees           Employee[]
  orders              Order[]
  cities              City[]
  organization        Organization @relation(fields: [organizationId], references: [id])

  @@map("scrap_yards")
}

model VehicleType {
  id             Int           @id @default(autoincrement())
  name           String
  icon           String?
  organizationId Int?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  vehicleNames   VehicleName[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([name, organizationId])
  @@map("vehicle_types")
}

model ScrapCategory {
  id             String       @id @default(uuid())
  name           String
  description    String?
  organizationId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("scrap_categories")
}

model VehicleName {
  id                   String                @id @default(uuid())
  name                 String
  vehicleTypeId        Int
  organizationId       Int
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  condition            String?
  make                 String?
  model                String?
  vehicleId            String?
  year                 Int?
  collectorAssignments CollectorAssignment[]
  organization         Organization          @relation(fields: [organizationId], references: [id])
  vehicleType          VehicleType           @relation(fields: [vehicleTypeId], references: [id])

  @@unique([name, vehicleTypeId, organizationId])
  @@map("vehicle_names")
}

model CollectorAssignment {
  id             String       @id @default(uuid())
  collectorId    String
  vehicleNameId  String?
  cityId         Int?
  organizationId Int
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  city           City?        @relation(fields: [cityId], references: [id])
  collector      Employee     @relation(fields: [collectorId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  vehicleName    VehicleName? @relation(fields: [vehicleNameId], references: [id])

  @@map("collector_assignments")
}

model Payment {
  id             String            @id @default(uuid())
  orderId        String            @unique
  customerId     String
  collectorId    String?
  amount         Float
  paymentType    PaymentTypeEnum
  receiptUrl     String?
  status         PaymentStatusEnum
  organizationId Int
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  collector      Employee?         @relation(fields: [collectorId], references: [id])
  customer       Customer          @relation(fields: [customerId], references: [id])
  order          Order             @relation(fields: [orderId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id])
  refund         Refund?
}

model Refund {
  id               String   @id @default(uuid())
  paymentId        String   @unique
  amount           Float
  reason           String?
  processedByAdmin String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  payment          Payment  @relation(fields: [paymentId], references: [id])

  @@map("refunds")
}

model Review {
  id             String       @id @default(uuid())
  orderId        String       @unique
  customerId     String
  collectorId    String
  rating         Int
  comment        String?
  organizationId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  collector      Employee     @relation(fields: [collectorId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])
  order          Order        @relation(fields: [orderId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model EmailTemplate {
  id             String       @id @default(uuid())
  name           String
  subject        String
  body           String
  variables      Json?
  organizationId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("email_templates")
}

model ChatbotLead {
  id             String   @id @default(uuid())
  name           String
  phone          String
  vehicleDetails Json
  location       String?
  chatLog        Json?
  leadId         String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lead           Lead?    @relation(fields: [leadId], references: [id])

  @@map("chatbot_leads")
}

model AIPriceEstimator {
  id                String               @id @default(uuid())
  make              String
  model             String
  year              Int
  condition         VehicleConditionEnum
  location          String?
  metalMarketRate   Float?
  estimatedPriceMin Float
  estimatedPriceMax Float
  confidenceScore   Float
  createdAt         DateTime             @default(now())

  @@map("ai_price_estimators")
}

model AIAutoQuote {
  id             String            @id @default(uuid())
  customerId     String?
  vehicleDetails Json
  generatedPrice Float
  respondedVia   QuoteResponseEnum
  timestamp      DateTime          @default(now())
  createdAt      DateTime          @default(now())

  @@map("ai_auto_quotes")
}

model Country {
  id            Int            @id @default(autoincrement())
  name          String
  currency      String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organizations Organization[]
}

model City {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique
  latitude             Float
  longitude            Float
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  scrapYardId          String?
  employees            Employee[]
  scrapYard            ScrapYard?            @relation(fields: [scrapYardId], references: [id])
  collectorAssignments CollectorAssignment[]

  @@map("cities")
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
  CUSTOMER
}

enum AdminRoleType {
  SUPER_ADMIN
  STAFF_ADMIN
}

enum CustomerStatus {
  ACTIVE
  BLOCKED
  INACTIVE
  VIP
}

enum EmployeeRole {
  COLLECTOR
  ADMIN
  SUPERVISOR
  ACCOUNTANT
}

enum VehicleTypeEnum {
  CAR
  BIKE
  TRUCK
  BOAT
  VAN
  SUV
}

enum VehicleConditionEnum {
  JUNK
  DAMAGED
  WRECKED
  ACCIDENTAL
  FULLY_SCRAP
}

enum LeadSourceEnum {
  WEBFORM
  CHATBOT
  CALL
  MANUAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUOTED
  CONVERTED
  REJECTED
}

enum OrderStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PickupRequestStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum PaymentTypeEnum {
  CASH
  CARD
  ONLINE
  BANK_TRANSFER
}

enum PaymentStatusEnum {
  UNPAID
  PAID
  REFUNDED
}

enum NotificationType {
  PICKUP_REQUEST
  PAYMENT_CONFIRMATION
  STATUS_UPDATE
  NEW_ASSIGNMENT
  ORDER_COMPLETED
  REFUND_PROCESSED
}

enum QuoteResponseEnum {
  EMAIL
  SMS
  CHATBOT
}
