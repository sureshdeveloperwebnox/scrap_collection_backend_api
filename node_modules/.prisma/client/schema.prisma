generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String?
  password     String?
  hashPassword String?
  firstName    String?
  lastName     String?
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  adminRoles     AdminRole[]
  customers      Customer[]
  employees      Employee[]
  notifications  Notification[]
  organizationId Int?
  organization   Organization?  @relation(fields: [organizationId], references: [id])

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
  CUSTOMER
}

model AdminRole {
  id          Int           @id @default(autoincrement())
  userId      String        @unique
  user        User          @relation(fields: [userId], references: [id])
  roleType    AdminRoleType
  permissions Json? // JSON field for permissions
  lastLogin   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum AdminRoleType {
  SUPER_ADMIN
  STAFF_ADMIN
}

// ============================================
// ORGANIZATION
// ============================================

model Organization {
  id          Int      @id @default(autoincrement())
  name        String
  address     String?
  phone       String?
  email       String?
  website     String?
  logo        String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  countryId   Int
  country     Country  @relation(fields: [countryId], references: [id])

  // Relations
  users           User[]
  customers       Customer[]
  employees       Employee[]
  leads           Lead[]
  vehicleTypes    VehicleType[]
  orders          Order[]
  scrapYards      ScrapYard[]
  payments        Payment[]
  reviews         Review[]
  pickupRequests  PickupRequest[]
  emailTemplates  EmailTemplate[]
  scrapCategories ScrapCategory[]
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id             String         @id @default(uuid())
  name           String
  phone          String
  email          String?
  address        String?
  latitude       Float?
  longitude      Float?
  accountStatus  CustomerStatus @default(ACTIVE)
  joinedDate     DateTime       @default(now())
  organizationId Int
  organization   Organization   @relation(fields: [organizationId], references: [id])
  userId         String?
  user           User?          @relation(fields: [userId], references: [id])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  orders         Order[]
  payments       Payment[]
  reviews        Review[]
  pickupRequests PickupRequest[]
  leads          Lead[]
}

enum CustomerStatus {
  ACTIVE
  BLOCKED
}

// ============================================
// EMPLOYEE/COLLECTOR MANAGEMENT
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  employees Employee[]

  @@map("roles")
}

model Employee {
  id               String       @id @default(uuid())
  fullName         String
  email            String
  phone            String
  roleId           Int
  role             Role         @relation(fields: [roleId], references: [id])
  cityId           Int?
  city             City?        @relation(fields: [cityId], references: [id])
  passwordHash     String
  isActive         Boolean      @default(true)
  profilePhoto     String? // URL
  rating           Float?       @default(0) // Average customer rating
  completedPickups Int          @default(0) // Performance metric
  deviceToken      String? // For push notifications
  organizationId   Int
  organization     Organization @relation(fields: [organizationId], references: [id])
  userId           String?
  user             User?        @relation(fields: [userId], references: [id])
  scrapYardId      String?
  scrapYard        ScrapYard?   @relation(fields: [scrapYardId], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  orders         Order[]
  reviews        Review[]
  pickupRequests PickupRequest[]
  payments       Payment[]
}

enum EmployeeRole {
  COLLECTOR
  ADMIN
  SUPERVISOR
  ACCOUNTANT
}

// ============================================
// LEAD MANAGEMENT
// ============================================

model Lead {
  id               String               @id @default(uuid())
  fullName         String
  phone            String
  email            String?
  vehicleType      VehicleTypeEnum
  vehicleMake      String?
  vehicleModel     String?
  vehicleYear      Int?
  vehicleCondition VehicleConditionEnum
  locationAddress  String?              @db.Text
  latitude         Float?
  longitude        Float?
  leadSource       LeadSourceEnum
  photos           Json? // JSON Array of image URLs
  notes            String?              @db.Text
  status           LeadStatus
  organizationId   Int
  organization     Organization         @relation(fields: [organizationId], references: [id])
  customerId       String?
  customer         Customer?            @relation(fields: [customerId], references: [id])
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  order       Order?
  timeline    LeadTimeline[]
  chatbotLead ChatbotLead?
}

enum VehicleTypeEnum {
  CAR
  BIKE
  TRUCK
  BOAT
  VAN
  SUV
}

enum VehicleConditionEnum {
  JUNK
  DAMAGED
  WRECKED
  ACCIDENTAL
  FULLY_SCRAP
}

enum LeadSourceEnum {
  WEBFORM
  CHATBOT
  CALL
  MANUAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUOTED
  CONVERTED
  REJECTED
}

model LeadTimeline {
  id          String   @id @default(uuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  activity    String   @db.Text
  performedBy String? // User ID or system
  createdAt   DateTime @default(now())

  @@map("lead_timelines")
}

// ============================================
// ORDER MANAGEMENT
// ============================================

model Order {
  id                  String            @id @default(uuid())
  leadId              String?           @unique
  lead                Lead?             @relation(fields: [leadId], references: [id])
  customerName        String
  customerPhone       String
  address             String            @db.Text
  latitude            Float?
  longitude           Float?
  vehicleDetails      Json // {make, model, year, condition}
  assignedCollectorId String?
  assignedCollector   Employee?         @relation(fields: [assignedCollectorId], references: [id])
  pickupTime          DateTime?
  orderStatus         OrderStatus
  paymentStatus       PaymentStatusEnum
  quotedPrice         Float?
  actualPrice         Float?
  yardId              String?
  yard                ScrapYard?        @relation(fields: [yardId], references: [id])
  customerNotes       String?           @db.Text
  adminNotes          String?           @db.Text
  organizationId      Int
  organization        Organization      @relation(fields: [organizationId], references: [id])
  customerId          String?
  customer            Customer?         @relation(fields: [customerId], references: [id])
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  payment       Payment?
  review        Review?
  pickupRequest PickupRequest?
  orderTimeline OrderTimeline[]
}

enum OrderStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model OrderTimeline {
  id          String      @id @default(uuid())
  orderId     String
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      OrderStatus
  notes       String?     @db.Text
  performedBy String? // User ID or system
  createdAt   DateTime    @default(now())

  @@map("order_timelines")
}

// ============================================
// PICKUP REQUEST MANAGEMENT
// ============================================

model PickupRequest {
  id                String              @id @default(uuid())
  customerId        String
  customer          Customer            @relation(fields: [customerId], references: [id])
  vehicleDetails    Json // Vehicle information
  pickupAddress     String              @db.Text
  latitude          Float?
  longitude         Float?
  status            PickupRequestStatus
  assignedTo        String?
  assignedCollector Employee?           @relation(fields: [assignedTo], references: [id])
  orderId           String?             @unique
  order             Order?              @relation(fields: [orderId], references: [id])
  organizationId    Int
  organization      Organization        @relation(fields: [organizationId], references: [id])
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("pickup_requests")
}

enum PickupRequestStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

// ============================================
// SCRAP YARD MANAGEMENT
// ============================================

model ScrapYard {
  id                  String       @id @default(uuid())
  yardName            String
  address             String       @db.Text
  latitude            Float?
  longitude           Float?
  capacity            Int
  assignedEmployeeIds Json? // JSON Array of employee IDs
  operatingHours      Json? // JSON object for operating hours
  organizationId      Int
  organization        Organization @relation(fields: [organizationId], references: [id])
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relations
  employees Employee[]
  orders    Order[]

  @@map("scrap_yards")
}

// ============================================
// VEHICLE TYPES & SCRAP CATEGORIES (MASTER TABLES)
// ============================================

model VehicleType {
  id             Int           @id @default(autoincrement())
  name           String
  icon           String? // Icon URL or identifier
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([name, organizationId])
  @@map("vehicle_types")
}

model ScrapCategory {
  id             String       @id @default(uuid())
  name           String
  description    String?      @db.Text
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("scrap_categories")
}

// ============================================
// PAYMENT & WALLET MANAGEMENT
// ============================================

model Payment {
  id             String            @id @default(uuid())
  orderId        String            @unique
  order          Order             @relation(fields: [orderId], references: [id])
  customerId     String
  customer       Customer          @relation(fields: [customerId], references: [id])
  collectorId    String?
  collector      Employee?         @relation(fields: [collectorId], references: [id])
  amount         Float
  paymentType    PaymentTypeEnum
  receiptUrl     String?
  status         PaymentStatusEnum
  organizationId Int
  organization   Organization      @relation(fields: [organizationId], references: [id])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  refund Refund?
}

enum PaymentTypeEnum {
  CASH
  CARD
  ONLINE
  BANK_TRANSFER
}

enum PaymentStatusEnum {
  UNPAID
  PAID
  REFUNDED
}

model Refund {
  id               String   @id @default(uuid())
  paymentId        String   @unique
  payment          Payment  @relation(fields: [paymentId], references: [id])
  amount           Float
  reason           String?  @db.Text
  processedByAdmin String? // Admin user ID
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("refunds")
}

// ============================================
// RATINGS & REVIEWS
// ============================================

model Review {
  id             String       @id @default(uuid())
  orderId        String       @unique
  order          Order        @relation(fields: [orderId], references: [id])
  customerId     String
  customer       Customer     @relation(fields: [customerId], references: [id])
  collectorId    String
  collector      Employee     @relation(fields: [collectorId], references: [id])
  rating         Int // 1-5
  comment        String?      @db.Text
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        Int              @id @default(autoincrement())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  title     String
  message   String           @db.Text
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@map("notifications")
}

enum NotificationType {
  PICKUP_REQUEST
  PAYMENT_CONFIRMATION
  STATUS_UPDATE
  NEW_ASSIGNMENT
  ORDER_COMPLETED
  REFUND_PROCESSED
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id             String       @id @default(uuid())
  name           String
  subject        String
  body           String       @db.Text
  variables      Json? // JSON object for template variables
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("email_templates")
}

// ============================================
// AI & AUTOMATION MODULES
// ============================================

model ChatbotLead {
  id             String   @id @default(uuid())
  name           String
  phone          String
  vehicleDetails Json // Vehicle information
  location       String?  @db.Text
  chatLog        Json? // JSON array of chat messages
  leadId         String?  @unique
  lead           Lead?    @relation(fields: [leadId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("chatbot_leads")
}

model AIPriceEstimator {
  id                String               @id @default(uuid())
  make              String
  model             String
  year              Int
  condition         VehicleConditionEnum
  location          String?              @db.Text
  metalMarketRate   Float?
  estimatedPriceMin Float
  estimatedPriceMax Float
  confidenceScore   Float // 0-1
  createdAt         DateTime             @default(now())

  @@map("ai_price_estimators")
}

model AIAutoQuote {
  id             String            @id @default(uuid())
  customerId     String?
  vehicleDetails Json // Vehicle information
  generatedPrice Float
  respondedVia   QuoteResponseEnum
  timestamp      DateTime          @default(now())
  createdAt      DateTime          @default(now())

  @@map("ai_auto_quotes")
}

enum QuoteResponseEnum {
  EMAIL
  SMS
  CHATBOT
}

// ============================================
// COUNTRY (EXISTING)
// ============================================

model Country {
  id            Int            @id @default(autoincrement())
  name          String
  currency      String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organizations Organization[]
}

// ============================================
// CITY (WORK ZONE)
// ============================================

model City {
  id        Int      @id @default(autoincrement())
  name      String
  latitude  Float
  longitude Float
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees Employee[]

  @@unique([name])
  @@map("cities")
}
